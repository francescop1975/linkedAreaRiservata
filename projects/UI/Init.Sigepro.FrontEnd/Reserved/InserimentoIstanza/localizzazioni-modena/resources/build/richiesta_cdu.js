var wrappers={object:{isVisible:function(e){return config_ol.html_page_elments.use_jquery?e.is(":visible"):"none"!=e.style.display},getObjectFromDOMbySelector:function(e){return config_ol.html_page_elments.use_jquery?$(e):document.querySelector(e)},getInputValue:function(e){return config_ol.html_page_elments.use_jquery?e.val():e.value},setInputValue:function(e,t){t=void 0;return config_ol.html_page_elments.use_jquery?e.val(t):e.value=t,t},emptyInputValue:function(e){config_ol.html_page_elments.use_jquery?e.val(void 0):e.value=void 0},getChildrenByTag:function(e,t){return config_ol.html_page_elments.use_jquery?e.children(t):e.getElementsByTagName(t)},setInnerHtmlValue:function(e,t){config_ol.html_page_elments.use_jquery?e.html(t):e.innerHTML=t},empty:function(e){if(config_ol.html_page_elments.use_jquery)e.empty();else for(;e.firstChild;)e.removeChild(e.firstChild)},hide:function(e){config_ol.html_page_elments.use_jquery?e.hide():e.style.display="none"},show:function(e){config_ol.html_page_elments.use_jquery?e.show():e.style.display="block"},removeChildrenByTagAndDataAttribute:function(e,t,l,o){var r=t+"["+l+'="'+o+'"]';if(config_ol.html_page_elments.use_jquery)e.children(r).remove();else for(var a=document.querySelectorAll(r),i=0;i<a.length;i++)e.removeChild(a[i])}},dropdown:{selectItemByValue:function(e,t){if(config_ol.html_page_elments.use_jquery)config_ol.html_page_elments.use_bootstrap_select?e.selectpicker("val",t):e.val(t);else for(var l=0;l<e.options.length;l++)if(e.options[l].value==t){e.selectedIndex=e.options[l].index;break}},selectFirstItem:function(e){config_ol.html_page_elments.use_jquery?(e.prop("selectedIndex",0).change(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("refresh")):e.hasChildNodes()?e.selectedIndex=0:e.selectedIndex=-1},addItem:function(e,t,l){if(config_ol.html_page_elments.use_jquery){var o=e.prop("options");o[o.length]=t,config_ol.html_page_elments.use_bootstrap_select&&l&&e.selectpicker("refresh")}else e.add(t)},getSelectedValue:function(e){return config_ol.html_page_elments.use_jquery?e.children("option").filter(":selected").val():e.options[e.selectedIndex].value},empty:function(e){config_ol.html_page_elments.use_jquery?(e.empty(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("render")):wrappers.object.empty(e)},hide:function(e){config_ol.html_page_elments.use_jquery?(e.hide(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("hide")):wrappers.object.hide(e)},show:function(e){config_ol.html_page_elments.use_jquery?(e.show(),config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("show")):wrappers.object.show(e)},refreshAfterUpdate:function(e){config_ol.html_page_elments.use_jquery&&config_ol.html_page_elments.use_bootstrap_select&&e.selectpicker("refresh")}},html_list:{addItem:function(e,t){config_ol.html_page_elments.use_jquery?e.append(t):e.appendChild(t)}},event:{addClickEventListener:function(e,t){config_ol.html_page_elments.use_jquery?e.click(t):e.addEventListener("click",t)},addChangeEventListener:function(e,t){config_ol.html_page_elments.use_jquery?e.change(t):e.addEventListener("change",t)},addKeydownEventListener:function(e,t){config_ol.html_page_elments.use_jquery?e.keydown(t):e.addEventListener("keydown",t)}}},commonUtils={common:{isUndefinedVar:function(e){return void 0===e||null==e},isArray:function(e){return!!e&&e.constructor===Array},isObject:function(e){return!!e&&e.constructor===Object},isString:function(e){return!!e&&e.constructor===String},isNumber:function(e){return!!e&&e.constructor===Number},compareIntegersAndLetters:function(e,t){var l=0;if(null==e||null==t)null==e&&null==t?l=0:null!=e&&null==t?l=1:null==e&&null!=t&&(l=-1);else{var o=parseInt(e),r=parseInt(t);isNaN(o)&&isNaN(r)?l=e.localeCompare(t):isNaN(o)&&!isNaN(r)?l=-1:!isNaN(o)&&isNaN(r)?l=1:isNaN(o)||isNaN(r)||(l=o-r)}return l}},array:{remove_duplicates:function(e){for(var t={},l=[],o=e.length,r=0,a=0;a<o;a++){var i=e[a];1!==t[i]&&(t[i]=1,l[r++]=i)}return l}},string:{isEmptyOrNull:function(e){return!!commonUtils.common.isUndefinedVar(e)||!!(commonUtils.common.isString(e)&&e.trim().length<1)},trim:function(e){for(;" "==e.substring(0,1);)e=e.substring(1,e.length);for(;" "==e.substring(e.length-1,e.length);)e=e.substring(0,e.length-1);return e},pad_string:function(e,t){return commonUtils.common.isUndefinedVar(e)&&(e=""),commonUtils.common.isUndefinedVar(t)?null:(t+e).slice(-t.length)}},html_list:{sortItemsByAttribute:function(e,t,l){do{for(var o,r=wrappers.object.getChildrenByTag(e,t),a=!1,i=!1,n=void 0,s=0;s<r.length-1;s++){o=r[s],n=r[s+1];var c=o.getAttribute(l),_=n.getAttribute(l);if(0<commonUtils.common.compareIntegersAndLetters(c,_)){a=!0;break}}a&&null!=o&&null!=n&&(o.parentNode.insertBefore(n,o),i=!0)}while(i)}}},gisUtils={filter_type_cql:"cql",getWFSFeatures:function(e,t,l,o,r){if(r){console.log("ATTENZIONE FUNZIONE SPERIMENTALE!!!! AL MOMENTO FUNZIONA SOLO CON NODEJS"),console.log("SENZA NODEJS LA RICHIESTA PARTE MA IL SISTEMA NON SEMBRA IN GRADO DI RECUPERARE IL JSON DI RISPOSTA");var a=(new ol.format.WFS).writeGetFeature(t);fetch(e+"/wfs",{method:"POST",credentials:"same-origin",redirect:"follow",agent:null,body:(new XMLSerializer).serializeToString(a)}).then(function(e){return e.json()}).then(function(e){return l(e)})}else{var i=Object.keys(t).map(function(e){return e+"="+t[e]}).join("&");fetch(e+"/wfs?"+i,{method:"GET",headers:{}}).then(function(e){return e.json()}).then(function(e){return l(e)}).catch(function(e){return o(e)})}},getFirstFeatureFromJsonResponse:function(e){var t=void 0,l=(new ol.format.GeoJSON).readFeatures(e);return null!=l&&0<l.length&&null!=l[0]&&(t=l[0]),t},prepareIntersectWithPointFilter:function(e,t,l,o,r){return e?new ol.format.filter.Intersects(t,new ol.geom.Point([l,o]),r):"INTERSECTS("+t+" ,POINT("+l+" "+o+"))"},prepareEqualToFilter:function(e,t,l,o){null==o&&(o=!1);return e?new ol.format.filter.equalTo(t,l,o):o?t+" = '"+l+"'":t+" ILIKE '"+l+"'"},prepareLikeFilter:function(e,t,l,o){null==o&&(o=!1);return e?new ol.format.filter.like(t,l,"*",".","!",o):o?t+" LIKE '"+l+"'":t+" ILIKE '"+l+"'"},prepareInFilter:function(e,t,l){var o=void 0;return e?console.log("metoodo da implentare"):o=t+" IN ('"+l.join("', '")+"')",o},prepareWFSRequestParams:function(e,t,l,o,r,a,i,n,s,c,_){if(commonUtils.string.isEmptyOrNull(t))console.log("Attenzione, obbligatorio indicare il nome del workspace da interrogare");else if(t=commonUtils.string.trim(t),commonUtils.string.isEmptyOrNull(l))console.log("Attenzione, obbligatorio indicare la URI del workspace da interrogare");else{if(l=commonUtils.string.trim(l),!commonUtils.string.isEmptyOrNull(r)){r=commonUtils.string.trim(r);var m=void 0;m=a?{featureNS:l,featurePrefix:t,srsName:r,outputFormat:"application/json"}:{service:"WFS",version:"2.0.0",request:"GetFeature",typenames:t+":"+e,outputFormat:encodeURIComponent("application/json"),srsName:r},commonUtils.common.isUndefinedVar(i)||(a||(i=i.replace(/ /g,"+")),commonUtils.common.isUndefinedVar(n)||"cql"!=n?m.filter=i:m.cql_filter=i);var g=void 0;return commonUtils.common.isArray(o)&&0<o.length?g=o:commonUtils.common.isString(o)&&!commonUtils.string.isEmptyOrNull(o)&&(g=[o=o.trim()]),!commonUtils.common.isUndefinedVar(g)&&0<g.length&&(a?m.propertyNames=g:m.propertyName=g.join(",")),commonUtils.string.isEmptyOrNull(c)||(m.sortBy=c,commonUtils.common.isUndefinedVar(_)&&(_=!0),m.sortBy=_?m.sortBy+"+A":m.sortBy+"+D"),commonUtils.string.isEmptyOrNull(s)||(m.featureID=commonUtils.string.trim(s)),m}console.log("Attenzione, obbligatorio indicare il sistema di coordinate da utilizzare")}},getWMSLayerFromParams:function(e,t,l,o,r,a){var i=null;if(void 0===e.sourceLayers||null==e.sourceLayers||e.sourceLayers.trim().length<1)console.log("Attenzione, campo sourceLayer non definito. impossibile creare questo layer");else{void 0!==e.visible&&null!=e.visible||(e.visible=!0),void 0!==e.tiled&&null!=e.tiled||(e.tiled=!1),(void 0===e.opacity||null==e.opacity||e.opacity<0)&&(e.opacity=1),(void 0===e.format||null==e.format||e.format.trim().length<1)&&(e.format="image/png"),(void 0===e.style||null==e.style||e.style.trim().length<1)&&(e.style="");var n=l;void 0===e.workspace||null==e.workspace||e.workspace.trim().length<1||(n+="/"+e.workspace),void 0===e.serviceType||null==e.serviceType||0==e.serviceType.trim()||"wms"==e.serviceType.trim().toLowerCase()?n+="/wms":"wms-c"==e.serviceType.trim().toLowerCase()&&(n+="/gwc/service/wms");var s={LAYERS:e.sourceLayers,FORMAT:e.format,STYLES:e.style};void 0===e.filter||null==e.filter||e.filter.trim().length<1||(s.CQL_FILTER=e.filter);var c={crossOrigin:null,params:s,projection:r,url:n};a&&(c.serverType="geoserver");var _={opacity:e.opacity,extent:o,visible:e.visible};i=1==e.tiled?(_.source=new ol.source.TileWMS(c),new ol.layer.Tile(_)):(_.source=new ol.source.ImageWMS(c),new ol.layer.Image(_))}return i},getWMSLayersGroup:function(e,t,l,o,r,a,i){var n=[];if(void 0===e||null==e||e.length<1)return log("Attenzione, in getWMSLayersGroup layersParams obbligatorio. impossibile generare il layergroup"),null;(void 0===l||null==l||l.trim().length<1)&&(l=t?"Cartografia di Sfondo":"Livelli di sovrapposizione");for(var s=0;s<e.length;s++)n[s]=getWMSLayerFromParams(e[s],t,o,r,a,i);return 0<n.length?new ol.layer.Group({title:l,layers:n}):null},sortFeaturesByAttribute:function(e,r){return e.sort(function(e,t){if(null!=e&&null==t)return 1;if(null==e&&null!=t)return-1;var l=e.getProperties()[r],o=t.getProperties()[r];return commonUtils.common.compareIntegersAndLetters(l,o)})}},catastoUtils={requestAllFogli:function(e,t){var l=config_ol.layer_foglio.field_name_comune+"='"+config_ol.layer_foglio.value_comune+"' AND "+config_ol.layer_foglio.field_name_sezione+"='"+config_ol.layer_foglio.value_sezione+"' AND "+config_ol.layer_foglio.field_name_allegato+"='"+config_ol.layer_foglio.def_value_allegato+"' AND "+config_ol.layer_foglio.field_name_sviluppo+"='"+config_ol.layer_foglio.def_value_sviluppo+"'",o=config_ol.layer_foglio.field_name_foglio,r=gisUtils.prepareWFSRequestParams(config_ol.layer_foglio.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_foglio.field_name_foglio],config_ol.coord_system_code,!1,l,gisUtils.filter_type_cql,void 0,o);null==t&&(t=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,e,t,!1)},requestAllParticelleByFoglio:function(e,t,l){if(commonUtils.string.isEmptyOrNull(e))console.log("non riesco a recuperare il valore per foglio catastale selezionato");else{var o=config_ol.layer_particella.field_name_comune+"='"+config_ol.layer_foglio.value_comune+"' AND "+config_ol.layer_particella.field_name_sezione+"='"+config_ol.layer_foglio.value_sezione+"' AND "+config_ol.layer_particella.field_name_foglio+"='"+e+"'",r=gisUtils.prepareWFSRequestParams(config_ol.layer_particella.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_particella.field_name_foglio,config_ol.layer_particella.field_name_mappale,config_ol.layer_particella.field_name_partkey],config_ol.coord_system_code,!1,o,gisUtils.filter_type_cql,void 0,config_ol.layer_particella.field_name_mappale);null==l&&(l=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,t,l,!1)}},requestSelectedParticelle:function(e,t,l){if(null!=e&&0<e.length){var o=void 0;o=1==e.length?gisUtils.prepareEqualToFilter(!1,config_ol.layer_particella.field_name_partkey,e[0]):gisUtils.prepareInFilter(!1,config_ol.layer_particella.field_name_partkey,e);var r=gisUtils.prepareWFSRequestParams(config_ol.layer_particella.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_particella.field_name_geom,config_ol.layer_particella.field_name_foglio,config_ol.layer_particella.field_name_mappale,config_ol.layer_particella.field_name_partkey],config_ol.coord_system_code,!1,o,gisUtils.filter_type_cql,void 0,config_ol.layer_particella.field_name_mappale);null==l&&(l=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,t,l,!1)}},requestFoglioByNumero:function(e,t,l){var o=gisUtils.prepareLikeFilter(!1,config_ol.layer_foglio.field_name_foglio,e),r=gisUtils.prepareWFSRequestParams(config_ol.layer_foglio.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_foglio.field_name_geom,config_ol.layer_foglio.field_name_foglio],config_ol.coord_system_code,!1,o,gisUtils.filter_type_cql);null==l&&(l=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,r,t,l,!1)},requestFoglioByIntersectionPoint:function(e,t,l){var o=gisUtils.prepareIntersectWithPointFilter(!1,config_ol.layer_foglio.field_name_geom,e,t,config_ol.coord_system_code),r=gisUtils.prepareWFSRequestParams(config_ol.layer_foglio.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_foglio.field_name_foglio],config_ol.coord_system_code,!1,o,gisUtils.filter_type_cql);gisUtils.getWFSFeatures(config_ol.url_geoserver,r,function(e){var t=(new ol.format.GeoJSON).readFeatures(e);null!=t&&null!=t[0]&&catastoUtils.requestFoglioByNumero(t[0].getProperties()[config_ol.layer_foglio.field_name_foglio],l)},catastoUtils.onError,!1)},requestParticellaByIntersectionPoint:function(e,t,l,o){var r=gisUtils.prepareIntersectWithPointFilter(!1,config_ol.layer_particella.field_name_geom,e,t,config_ol.coord_system_code),a=gisUtils.prepareWFSRequestParams(config_ol.layer_particella.layer_name,config_ol.gs_default_workspace_name,config_ol.gs_default_workspace_URI,[config_ol.layer_particella.field_name_geom,config_ol.layer_particella.field_name_foglio,config_ol.layer_particella.field_name_mappale,config_ol.layer_particella.field_name_partkey],config_ol.coord_system_code,!1,r,gisUtils.filter_type_cql);null==o&&(o=catastoUtils.onError),gisUtils.getWFSFeatures(config_ol.url_geoserver,a,l,o,!1)},isAllParticelleOfSameFoglio:function(e,t){var l=!1;if(null!=t)for(var o=0;o<t.length;o++){if(catastoUtils.getNumeroFoglioFromPartkey(t[o])!=e){l=!0;break}}return!l},getNumeroFoglioFromPartkey:function(e){if(null!=e&&0<e.length)return e.substring(5,9).trim()},getValoreMappaleFromPartkey:function(e){if(null!=e&&0<e.length)return e.substring(9).trim().toUpperCase()},createPartkey:function(e,t,l){var o=e.trim().padEnd(5," ");return o=o.concat(t.trim().padStart(4," ")),l=l.trim(),o=isNaN(l)?o.concat(l.trim().padEnd(5," ")):o.concat(l.trim().padStart(5," "))},onError:function(e){console.log("request failed",e)}},arrayParticelleInput=void 0,callBack=void 0;function setArrayParticelleInput(e){arrayParticelleInput=e}function setCallBack(e){callBack=e}function createMapLayers(){var e={layer_perimetro_comunale:void 0,layer_carto_base:void 0,tms:void 0,layer_group:void 0,layer_catasto_fogli:void 0,layer_catasto_particelle:void 0,layer_vett_foglio:void 0,layer_vett_particelle:void 0};return e.layer_perimetro_comunale=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.baselayers_name.layer_name_perimetrocom,workspace:config_ol.gs_default_workspace_name,serviceType:"wms",visible:!0,tiled:!1,opacity:1,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.layer_carto_base=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.baselayers_name.layer_name_viecivici,workspace:config_ol.gs_default_workspace_name,serviceType:"wms",visible:!0,tiled:!1,opacity:.7,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.tms=new ol.layer.Tile({preload:1,source:new ol.source.TileImage({crossOrigin:null,extent:config_ol.tms_extent,projection:config_ol.projection,tileGrid:new ol.tilegrid.TileGrid({extent:config_ol.tms_extent,origin:config_ol.tms_origin,resolutions:config_ol.tms_resolutions}),tileUrlFunction:function(e){if(null!==e){var t=e[0],l=e[1],o=e[2];return config_ol.tms_base_url+config_ol.tms_last_year_geo+"/"+t+"/"+l+"/"+o+"."+config_ol.tms_image_extension}}})}),e.layer_catasto_fogli=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.layer_foglio.layer_name,workspace:config_ol.gs_default_workspace_name,style:config_ol.layer_foglio.style,serviceType:"wms",visible:!0,tiled:!1,opacity:1,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.layer_catasto_particelle=gisUtils.getWMSLayerFromParams({sourceLayers:config_ol.gs_default_workspace_name+":"+config_ol.layer_particella.layer_name,workspace:config_ol.gs_default_workspace_name,style:config_ol.layer_particella.style,serviceType:"wms",visible:!1,tiled:!1,opacity:1,format:"image/png"},!0,config_ol.url_geoserver,config_ol.territory_extent,config_ol.coord_system_code,!0),e.layer_vett_foglio=new ol.layer.Vector({source:new ol.source.Vector,title:"Foglio Selezionato",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(153, 0, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#990000",width:3})})}),e.layer_vett_particelle=new ol.layer.Vector({source:new ol.source.Vector,title:"Particelle Selezionate",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(35, 209, 99, 0.2)"}),stroke:new ol.style.Stroke({color:"#7BEF51",width:3})})}),e}function initializeFormAndMap(e){resetHTMLForm(!0),populateFogliDropDownList(e),null!=arrayParticelleInput&&0<arrayParticelleInput.length&&(navigation.seLectedFoglio=catastoUtils.getNumeroFoglioFromPartkey(arrayParticelleInput[0]),null!=navigation.seLectedFoglio?(wrappers.dropdown.selectItemByValue(html_fogli_DropDownList,navigation.seLectedFoglio),catastoUtils.requestFoglioByNumero(navigation.seLectedFoglio,onRequestFoglioSuccess),arrayParticelleInput=commonUtils.array.remove_duplicates(arrayParticelleInput),catastoUtils.isAllParticelleOfSameFoglio(navigation.seLectedFoglio,arrayParticelleInput)&&catastoUtils.requestSelectedParticelle(arrayParticelleInput,function(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&0<t.length){layersProgetto.layer_vett_particelle.getSource().clear(),layersProgetto.layer_vett_particelle.getSource().addFeatures(t);for(var l=0;l<t.length;l++){var o=t[l].getProperties(),r=o[config_ol.layer_particella.field_name_partkey],a=o[config_ol.layer_particella.field_name_mappale],i=arrayParticelleInput.indexOf(r);-1<i&&(arrayParticelleInput.splice(i,1),wrappers.html_list.addItem(html_selectedParticelleHtmlList,createPartKeyHtmlListElement(r,a)),navigation.selectedParticelle.push(r))}if(commonUtils.html_list.sortItemsByAttribute(html_selectedParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partnumber),wrappers.dropdown.show(html_selectedParticelleHtmlListTitle),0<arrayParticelleInput.length){do{r=arrayParticelleInput.pop(),a=catastoUtils.getValoreMappaleFromPartkey(r);wrappers.html_list.addItem(html_createdParticelleHtmlList,createPartKeyHtmlListElement(r,a,!1)),navigation.createdParticelle.push(r)}while(0<arrayParticelleInput.length);commonUtils.html_list.sortItemsByAttribute(html_createdParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partnumber),wrappers.dropdown.show(html_createdParticelleHtmlListTitle)}wrappers.object.show(html_selectionBlockDiv),wrappers.object.show(html_buttonConfirm),map.getView().fit(layersProgetto.layer_vett_particelle.getSource().getExtent())}})):console.log("non riesco a recuperare il valore per foglio catastale selezionato")),wrappers.event.addClickEventListener(html_buttonConfirm,onConfirmSelection),wrappers.event.addClickEventListener(html_buttonReset,onResetApplication),html_modalBox.on("show.bs.modal",onModalShow),wrappers.event.addKeydownEventListener(modalParticellaValue,onKeydownModalParticella),wrappers.event.addClickEventListener(html_buttonConfirmParticellaNuova,onConfirmAddParticella),wrappers.event.addChangeEventListener(html_fogli_DropDownList,onChangeFogliDropDown),wrappers.event.addChangeEventListener(html_mappali_DropDownList,onChangeParticelleDropDown)}function isParticellaInFoglioCorretto(e){return e[config_ol.layer_particella.field_name_foglio]==navigation.seLectedFoglio}function resetHTMLForm(e){wrappers.object.empty(html_selectedFoglioTitolo),wrappers.object.empty(html_selectedParticelleHtmlList),wrappers.object.empty(html_createdParticelleHtmlList),wrappers.dropdown.hide(html_selectedParticelleHtmlListTitle),wrappers.dropdown.hide(html_createdParticelleHtmlListTitle),wrappers.object.empty(html_mappali_DropDownList),wrappers.dropdown.hide(html_mappali_DropDownList),wrappers.dropdown.show(html_mappali_DropDownList_empty),wrappers.object.hide(html_selectionBlockDiv),e||wrappers.dropdown.selectFirstItem(html_fogli_DropDownList)}function resetNavigation(){navigation.intersectionPoint=void 0,navigation.seLectedFoglio=void 0,navigation.selectedParticelle=[],navigation.createdParticelle=[]}function resetMap(){layersProgetto.layer_vett_foglio.getSource().clear(),layersProgetto.layer_vett_particelle.getSource().clear();var e=layersProgetto.layer_catasto_particelle.getSource().getParams();e.CQL_FILTER="1=2",layersProgetto.layer_catasto_particelle.getSource().updateParams(e),map.getView().fit(config_ol.tms_extent)}function onMapClick(e){navigation.intersectionPoint=e.coordinate,void 0===navigation.seLectedFoglio?catastoUtils.requestFoglioByIntersectionPoint(navigation.intersectionPoint[0],navigation.intersectionPoint[1],onRequestFoglioSuccess):catastoUtils.requestParticellaByIntersectionPoint(navigation.intersectionPoint[0],navigation.intersectionPoint[1],addRemoveParticellaFromSelectionList)}function onChangeFogliDropDown(e){var t=e.target.value;resetNavigation(),resetHTMLForm(!0),resetMap(),wrappers.object.hide(html_buttonConfirm),catastoUtils.requestFoglioByNumero(t,onRequestFoglioSuccess)}function onChangeParticelleDropDown(e){var t=e.target.value;if(!navigation.selectedParticelle.includes(t)){var l=catastoUtils.getNumeroFoglioFromPartkey(t),o=wrappers.dropdown.getSelectedValue(html_fogli_DropDownList);if(l==o){catastoUtils.requestSelectedParticelle([t],function(e){var t=gisUtils.getFirstFeatureFromJsonResponse(e),l=t.getProperties();null!=t&&isParticellaInFoglioCorretto(l)&&commonAddParticellaFeatureToVectorLayer(t,!0)})}else console.log("errore imprevisto. la paricella richiesta ("+t+") non fa parte del foglio selezionato ("+o+").")}}function onConfirmSelection(){catastoUtils.isAllParticelleOfSameFoglio(navigation.seLectedFoglio,navigation.selectedParticelle)&&catastoUtils.isAllParticelleOfSameFoglio(navigation.seLectedFoglio,navigation.manualParticelle)?(!commonUtils.common.isUndefinedVar(navigation.selectedParticelle)&&0<navigation.selectedParticelle.length&&(navigation.selectedParticelle=commonUtils.array.remove_duplicates(navigation.selectedParticelle),navigation.selectedParticelle=navigation.selectedParticelle.sort(function(e,t){if(null!=e&&null==t)return 1;if(null==e&&null!=t)return-1;var l=catastoUtils.getValoreMappaleFromPartkey(e),o=catastoUtils.getValoreMappaleFromPartkey(t);return commonUtils.common.compareIntegersAndLetters(l,o)})),!commonUtils.common.isUndefinedVar(navigation.createdParticelle)&&0<navigation.createdParticelle.length&&(navigation.createdParticelle=commonUtils.array.remove_duplicates(navigation.createdParticelle),navigation.createdParticelle=navigation.createdParticelle.sort(function(e,t){if(null!=e&&null==t)return 1;if(null==e&&null!=t)return-1;var l=catastoUtils.getValoreMappaleFromPartkey(e),o=catastoUtils.getValoreMappaleFromPartkey(t);return commonUtils.common.compareIntegersAndLetters(l,o)})),callBack(navigation.selectedParticelle,navigation.createdParticelle)):console.log("Attenzione, alcune delle particelle selezionate non appartengono al foglio selezionato")}function onKeydownModalParticella(){setModalParticellaValidity("")}function onConfirmAddParticella(){var e=wrappers.object.getInputValue(modalParticellaValue);if(commonUtils.string.isEmptyOrNull(e)||0==commonUtils.string.trim(e).length)setModalParticellaValidity("Fornire la particella");else{var i=catastoUtils.createPartkey(config_ol.layer_foglio.value_comune,navigation.seLectedFoglio,e);-1==navigation.selectedParticelle.indexOf(i)?catastoUtils.requestSelectedParticelle([i],function(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&0<t.length){layersProgetto.layer_vett_particelle.getSource().addFeatures(t);for(var l=0;l<t.length;l++){var o=t[l].getProperties(),r=o[config_ol.layer_particella.field_name_partkey],a=o[config_ol.layer_particella.field_name_mappale];wrappers.html_list.addItem(html_selectedParticelleHtmlList,createPartKeyHtmlListElement(r,a,!0)),navigation.selectedParticelle.push(r)}commonUtils.html_list.sortItemsByAttribute(html_selectedParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partnumber),wrappers.dropdown.show(html_selectedParticelleHtmlListTitle),wrappers.object.show(html_selectionBlockDiv),wrappers.object.show(html_buttonConfirm),map.getView().fit(layersProgetto.layer_vett_particelle.getSource().getExtent()),html_modalBox.modal("hide")}else{if(-1==navigation.createdParticelle.indexOf(i)){a=catastoUtils.getValoreMappaleFromPartkey(i);wrappers.html_list.addItem(html_createdParticelleHtmlList,createPartKeyHtmlListElement(i,a,!1)),navigation.createdParticelle.push(i),commonUtils.html_list.sortItemsByAttribute(html_createdParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partnumber),wrappers.dropdown.show(html_createdParticelleHtmlListTitle),wrappers.object.show(html_selectionBlockDiv),wrappers.object.show(html_buttonConfirm),html_modalBox.modal("hide")}else setModalParticellaValidity("La particella non in mappa è già presente nella lista.")}}):setModalParticellaValidity("La particella è grafica ed è già presente nella lista.")}}function onResetApplication(){resetNavigation(),resetHTMLForm(!1),resetMap(),wrappers.object.hide(html_buttonConfirm)}function createPartKeyHtmlListElement(e,t,l){commonUtils.common.isUndefinedVar(l)&&(l=!0);var o=document.createElement("li");o.setAttribute("class","list-group-item d-flex justify-content-between align-items-center");var r=document.createElement("span");r.setAttribute("class","badge badge-danger badge-pill");var a=document.createElement("a");a.setAttribute("href","#"),a.setAttribute("class","ol-closer"),l?a.setAttribute("onclick","eliminaPartKeyGraficoDaSelezione('"+e+"')"):a.setAttribute("onclick","eliminaPartKeyManualeDaSelezione('"+e+"')"),r.appendChild(a);var i=document.createElement("span");i.setAttribute("class","particella_value_container");var n=document.createTextNode(t);return i.appendChild(n),o.appendChild(i),o.appendChild(r),o.setAttribute(config_ol.html_page_elments.form_list_element_partkey,e),o.setAttribute(config_ol.html_page_elments.form_list_element_partnumber,t),o}function setTitoloFoglioSelezionato(e){wrappers.object.setInnerHtmlValue(html_selectedFoglioTitolo,e)}function populateFogliDropDownList(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&0<t.length){t=gisUtils.sortFeaturesByAttribute(t,config_ol.layer_foglio.field_name_foglio),wrappers.dropdown.empty(html_fogli_DropDownList);var l=new Option(" - fogli - ","",!0,!0);wrappers.dropdown.addItem(html_fogli_DropDownList,l,!1);for(var o=0;o<t.length;o++){var r=t[o].getProperties(),a=r[config_ol.layer_foglio.field_name_foglio],i=r[config_ol.layer_foglio.field_name_foglio],n=new Option(i,a,!1,!1);wrappers.dropdown.addItem(html_fogli_DropDownList,n,!1)}wrappers.dropdown.refreshAfterUpdate(html_fogli_DropDownList)}}function populateParticelleDropDownList(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&0<t.length){t=gisUtils.sortFeaturesByAttribute(t,config_ol.layer_particella.field_name_mappale),wrappers.dropdown.empty(html_mappali_DropDownList);var l=new Option(" - mappali - ","",!0,!0);wrappers.dropdown.addItem(html_mappali_DropDownList,l,!1);for(var o=0;o<t.length;o++){var r=t[o].getProperties(),a=r[config_ol.layer_particella.field_name_partkey],i=r[config_ol.layer_particella.field_name_mappale],n=new Option(i,a,!1,!1);wrappers.dropdown.addItem(html_mappali_DropDownList,n,!1)}wrappers.dropdown.refreshAfterUpdate(html_mappali_DropDownList),wrappers.dropdown.show(html_mappali_DropDownList),wrappers.dropdown.hide(html_mappali_DropDownList_empty)}}function onRequestFoglioSuccess(e){var t=(new ol.format.GeoJSON).readFeatures(e);if(null!=t&&null!=t[0]){navigation.seLectedFoglio=t[0].getProperties()[config_ol.layer_foglio.field_name_foglio],setTitoloFoglioSelezionato("Foglio "+navigation.seLectedFoglio);var l=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.modal_foglio_cell);wrappers.object.setInnerHtmlValue(l,navigation.seLectedFoglio),wrappers.object.show(html_selectionBlockDiv);for(var o=0;o<t.length;o++){t[o].getProperties()[config_ol.layer_foglio.field_name_foglio]==navigation.seLectedFoglio&&layersProgetto.layer_vett_foglio.getSource().addFeature(t[o])}config_ol.layer_foglio.fit_selected_area_when_change&&map.getView().fit(layersProgetto.layer_vett_foglio.getSource().getExtent());var r=layersProgetto.layer_catasto_particelle.getSource().getParams();r.CQL_FILTER=config_ol.layer_particella.field_name_foglio+"='"+navigation.seLectedFoglio+"'",layersProgetto.layer_catasto_particelle.getSource().updateParams(r),layersProgetto.layer_catasto_particelle.setVisible(!0),wrappers.dropdown.hide(html_mappali_DropDownList),wrappers.dropdown.show(html_mappali_DropDownList_empty),catastoUtils.requestAllParticelleByFoglio(navigation.seLectedFoglio,populateParticelleDropDownList),wrappers.dropdown.getSelectedValue(html_fogli_DropDownList)!=navigation.seLectedFoglio&&wrappers.dropdown.selectItemByValue(html_fogli_DropDownList,navigation.seLectedFoglio)}}function addRemoveParticellaFromSelectionList(e){var t=gisUtils.getFirstFeatureFromJsonResponse(e);if(null!=t){var l=t.getProperties();if(isParticellaInFoglioCorretto(l)){var o=l[config_ol.layer_particella.field_name_partkey];-1<navigation.selectedParticelle.indexOf(o)?eliminaPartKeyGraficoDaSelezione(o):commonAddParticellaFeatureToVectorLayer(t,!1)}}}function commonAddParticellaFeatureToVectorLayer(e,t){var l=e.getProperties(),o=l[config_ol.layer_particella.field_name_partkey],r=l[config_ol.layer_particella.field_name_mappale];navigation.selectedParticelle.push(o),wrappers.object.isVisible(html_buttonConfirm)||wrappers.object.show(html_buttonConfirm),wrappers.html_list.addItem(html_selectedParticelleHtmlList,createPartKeyHtmlListElement(o,r)),commonUtils.html_list.sortItemsByAttribute(html_selectedParticelleHtmlList,"li",config_ol.html_page_elments.form_list_element_partnumber),wrappers.dropdown.show(html_selectedParticelleHtmlListTitle),layersProgetto.layer_vett_particelle.getSource().addFeature(e),config_ol.layer_particella.fit_selected_area_when_change&&map.getView().fit(layersProgetto.layer_vett_particelle.getSource().getExtent()),t||wrappers.dropdown.getSelectedValue(html_mappali_DropDownList)!=o&&wrappers.dropdown.selectItemByValue(html_mappali_DropDownList,o)}function eliminaPartKeyGraficoDaSelezione(t){var e=navigation.selectedParticelle.indexOf(t);if(-1<e){var l=layersProgetto.layer_vett_particelle.getSource().forEachFeature(function(e){if(e.getProperties()[config_ol.layer_particella.field_name_partkey]==t)return e});null!=l&&(layersProgetto.layer_vett_particelle.getSource().removeFeature(l),navigation.selectedParticelle.splice(e,1),config_ol.layer_particella.fit_selected_area_when_change&&(0<navigation.selectedParticelle.length?map.getView().fit(layersProgetto.layer_vett_particelle.getSource().getExtent()):map.getView().fit(layersProgetto.layer_vett_foglio.getSource().getExtent()))),eliminaPartkey(t,html_selectedParticelleHtmlList,html_selectedParticelleHtmlListTitle)}}function eliminaPartKeyManualeDaSelezione(e){var t=navigation.createdParticelle.indexOf(e);-1<t&&(navigation.createdParticelle.splice(t,1),eliminaPartkey(e,html_createdParticelleHtmlList,html_createdParticelleHtmlListTitle))}function eliminaPartkey(e,t,l){wrappers.object.removeChildrenByTagAndDataAttribute(t,"li",config_ol.html_page_elments.form_list_element_partkey,e);var o=wrappers.object.getChildrenByTag(t,"li");!commonUtils.common.isUndefinedVar(o)&&0!=o.length||wrappers.dropdown.hide(l),!commonUtils.common.isUndefinedVar(navigation.selectedParticelle)&&0!=navigation.selectedParticelle.length||!commonUtils.common.isUndefinedVar(navigation.createdParticelle)&&0!=navigation.createdParticelle.length||wrappers.object.hide(html_buttonConfirm)}function onModalShow(e){modalParticellaValue.css("border-color","black"),setModalParticellaValidity(""),wrappers.object.emptyInputValue(modalParticellaValue),html_modalBox.modal("show")}function setModalParticellaValidity(e){modalParticellaValue[0];""!=e?(modalParticellaValue.popover({placement:"right",trigger:"manual",html:!0,content:e}),modalParticellaValue.popover("show"),modalParticellaValue.css("outline-style","solid"),modalParticellaValue.css("outline-color","red")):(modalParticellaValue.popover("dispose"),modalParticellaValue.css("outline-style","none"))}var html_selectedFoglioTitolo,html_selectedParticelleHtmlList,html_createdParticelleHtmlList,html_fogli_DropDownList,html_mappali_DropDownList,html_mappali_DropDownList_empty,html_selectionBlockDiv,navigation,layersProgetto,html_selectedParticelleHtmlListTitle,html_createdParticelleHtmlListTitle,html_buttonShowModal,html_modalBox,modalParticellaValue,html_buttonReset,html_buttonConfirm,html_buttonConfirmParticellaNuova,map=void 0;function run(e,t){setArrayParticelleInput(e),setCallBack(t),navigation={intersectionPoint:void 0,seLectedFoglio:void 0,selectedParticelle:[],createdParticelle:[]},html_selectionBlockDiv=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.selection_block_div),html_selectedFoglioTitolo=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.selected_foglio_div),html_selectedParticelleHtmlList=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.selected_particelle_div),html_createdParticelleHtmlList=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.created_particelle_div),html_selectedParticelleHtmlListTitle=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.selected_particelle_title),html_createdParticelleHtmlListTitle=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.created_particelle_title),html_fogli_DropDownList=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.fogli_input_select),html_mappali_DropDownList=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.mappali_input_select),html_mappali_DropDownList_empty=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.mappali_input_select_alt_txt),html_buttonConfirm=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.button_confirm_selection),html_buttonShowModal=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.button_open_modal_partkey),html_modalBox=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.modal_box),modalParticellaValue=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.modal_particella_input),html_buttonConfirmParticellaNuova=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.modal_particella_button_confirm),html_buttonReset=wrappers.object.getObjectFromDOMbySelector(config_ol.html_page_elments.button_reset_selection),layersProgetto=createMapLayers();var l={controls:ol.control.defaults().extend([new ol.control.FullScreen({source:"fullscreen"})]),layers:new ol.layer.Group({title:"Livelli di Base",layers:[layersProgetto.tms,layersProgetto.layer_carto_base,layersProgetto.layer_perimetro_comunale]}),target:config_ol.html_page_elments.map_div,view:new ol.View({projection:config_ol.projection,center:config_ol.territory_center_point,zoom:config_ol.initial_zoom,minZoom:config_ol.min_zoom,maxZoom:config_ol.max_zoom,extent:config_ol.tms_extent})};(map=new ol.Map(l)).addLayer(layersProgetto.layer_catasto_fogli),map.addLayer(layersProgetto.layer_catasto_particelle),map.addLayer(layersProgetto.layer_vett_foglio),map.addLayer(layersProgetto.layer_vett_particelle),map.on("click",onMapClick),catastoUtils.requestAllFogli(initializeFormAndMap)}